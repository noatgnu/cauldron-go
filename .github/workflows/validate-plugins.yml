name: Validate Plugins

on:
  push:
    paths:
      - 'plugins/**'
      - 'cmd/plugin-validator/**'
      - 'backend/models/plugin*.go'
      - 'backend/services/plugin_loader*.go'
  pull_request:
    paths:
      - 'plugins/**'
      - 'cmd/plugin-validator/**'
      - 'backend/models/plugin*.go'
      - 'backend/services/plugin_loader*.go'

jobs:
  validate-plugins:
    name: Validate Plugin Configurations
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Build validator
        run: |
          mkdir -p bin
          go build -o bin/plugin-validator ./cmd/plugin-validator
          chmod +x bin/plugin-validator

      - name: Test validator binary
        run: |
          ./bin/plugin-validator --help || echo "Validator built successfully"
          if [ ! -f bin/plugin-validator ]; then
            echo "[ERROR] Validator binary not found"
            exit 1
          fi
          echo "[SUCCESS] Validator binary built and ready"

      - name: Validate plugins
        run: |
          echo "Validating plugin configurations..."
          ./bin/plugin-validator plugins/

      - name: Verify validation results
        run: |
          if [ $? -eq 0 ]; then
            echo "[SUCCESS] All plugins validated successfully"
          else
            echo "[ERROR] Plugin validation failed"
            exit 1
          fi

  generate-docs:
    name: Generate Plugin Documentation
    runs-on: ubuntu-latest
    needs: validate-plugins

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Build documentation generators
        run: |
          mkdir -p bin
          go build -o bin/plugin-doc-generator ./cmd/plugin-doc-generator
          go build -o bin/plugin-doc-generator-all ./cmd/plugin-doc-generator-all
          chmod +x bin/plugin-doc-generator bin/plugin-doc-generator-all

      - name: Test documentation generators
        run: |
          if [ ! -f bin/plugin-doc-generator ]; then
            echo "[ERROR] plugin-doc-generator binary not found"
            exit 1
          fi
          if [ ! -f bin/plugin-doc-generator-all ]; then
            echo "[ERROR] plugin-doc-generator-all binary not found"
            exit 1
          fi
          echo "[SUCCESS] Documentation generators built successfully"

      - name: Generate documentation
        run: |
          echo "Generating plugin documentation..."
          ./bin/plugin-doc-generator-all

      - name: Check for documentation updates
        run: |
          if [ -n "$(git status --porcelain plugins/*/README.md)" ]; then
            echo "[WARNING] Plugin documentation is out of date"
            echo "Please run: ./bin/plugin-doc-generator-all"
            git diff plugins/*/README.md
            exit 1
          fi
          echo "[SUCCESS] All documentation is up to date"

  test-developer-tools:
    name: Test All Developer Tools
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Build all developer tools
        run: |
          mkdir -p bin
          echo "Building plugin-validator..."
          go build -o bin/plugin-validator ./cmd/plugin-validator
          echo "Building plugin-doc-generator..."
          go build -o bin/plugin-doc-generator ./cmd/plugin-doc-generator
          echo "Building plugin-doc-generator-all..."
          go build -o bin/plugin-doc-generator-all ./cmd/plugin-doc-generator-all
          echo "Building plugin-scaffolder..."
          go build -o bin/plugin-scaffolder ./cmd/plugin-scaffolder
          chmod +x bin/*

      - name: Verify binaries
        run: |
          echo "Verifying plugin-validator..."
          ls -lh bin/plugin-validator
          echo "Verifying plugin-doc-generator..."
          ls -lh bin/plugin-doc-generator
          echo "Verifying plugin-doc-generator-all..."
          ls -lh bin/plugin-doc-generator-all
          echo "Verifying plugin-scaffolder..."
          ls -lh bin/plugin-scaffolder
          echo "[SUCCESS] All developer tools built successfully"

      - name: Test plugin-validator
        run: |
          echo "Testing plugin-validator..."
          ./bin/plugin-validator plugins/ || exit 1
          echo "[SUCCESS] plugin-validator works"

      - name: Test plugin-doc-generator-all
        run: |
          echo "Testing plugin-doc-generator-all..."
          ./bin/plugin-doc-generator-all || exit 1
          echo "[SUCCESS] plugin-doc-generator-all works"

  lint-yaml:
    name: Lint YAML Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Lint YAML files
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: plugins/
          config_data: |
            extends: default
            rules:
              line-length:
                max: 120
                level: warning
              indentation:
                spaces: 2
              comments:
                min-spaces-from-content: 1
