name: Validate Plugins

on:
  push:
    paths:
      - 'plugins/**'
      - 'schemas/**'
      - 'scripts/validate-plugin*.sh'
      - 'scripts/validate-plugin*.py'
  pull_request:
    paths:
      - 'plugins/**'
      - 'schemas/**'

jobs:
  validate-plugins:
    name: Validate Plugin Configurations
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Build validator
        run: |
          go build -o bin/plugin-validator ./cmd/plugin-validator

      - name: Validate plugins
        run: |
          echo "Validating plugin configurations..."
          ./bin/plugin-validator plugins/

  generate-docs:
    name: Generate Plugin Documentation
    runs-on: ubuntu-latest
    needs: validate-plugins

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Build documentation generators
        run: |
          go build -o bin/plugin-doc-generator ./cmd/plugin-doc-generator
          go build -o bin/plugin-doc-generator-all ./cmd/plugin-doc-generator-all

      - name: Generate documentation
        run: |
          echo "Generating plugin documentation..."
          ./bin/plugin-doc-generator-all

      - name: Check for documentation updates
        run: |
          if [ -n "$(git status --porcelain plugins/*/README.md)" ]; then
            echo "[WARNING] Plugin documentation is out of date"
            echo "Please run: ./bin/plugin-doc-generator-all"
            git diff plugins/*/README.md
            exit 1
          fi
          echo "[SUCCESS] All documentation is up to date"

  lint-yaml:
    name: Lint YAML Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Lint YAML files
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: plugins/
          config_data: |
            extends: default
            rules:
              line-length:
                max: 120
                level: warning
              indentation:
                spaces: 2
              comments:
                min-spaces-from-content: 1
