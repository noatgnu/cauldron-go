<div class="plugin-execute-container">
  @if (loading()) {
    <div class="loading">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Loading plugin...</p>
    </div>
  } @else if (error()) {
    <div class="error">
      <mat-icon>error</mat-icon>
      <p>{{ error() }}</p>
    </div>
  } @else if (plugin()) {
    <mat-card class="plugin-card">
      <mat-card-header>
        <mat-icon mat-card-avatar>{{ plugin()!.definition.plugin.icon || 'extension' }}</mat-icon>
        <mat-card-title>{{ plugin()!.definition.plugin.name }}</mat-card-title>
        <mat-card-subtitle>
          {{ plugin()!.definition.plugin.description }}
        </mat-card-subtitle>
      </mat-card-header>

      <app-environment-indicator
        [python]="getRuntimeIcon(plugin()!.definition.runtime.type).python"
        [r]="getRuntimeIcon(plugin()!.definition.runtime.type).r"
        [pythonWithR]="getRuntimeIcon(plugin()!.definition.runtime.type).pythonWithR"
        [direct]="getRuntimeIcon(plugin()!.definition.runtime.type).direct">
      </app-environment-indicator>

      <mat-card-content>
        <app-dynamic-form
          [plugin]="plugin()!"
          [disabled]="executing()"
          (formSubmit)="onExecute($event)">
        </app-dynamic-form>
      </mat-card-content>

      <mat-card-actions align="end">
        @if (plugin()!.definition.example?.enabled) {
          <button mat-button (click)="loadExample()" [disabled]="executing() || loading()">
            Load Example
          </button>
        }
        <button mat-button (click)="reset()" [disabled]="executing()">
          Reset
        </button>
        <button mat-raised-button color="primary" (click)="dynamicForm?.submit()" [disabled]="executing() || loading()">
          @if (executing()) {
            <mat-spinner diameter="16"></mat-spinner>
            Running...
          } @else {
            Run Analysis
          }
        </button>
        @if (createdJobId()) {
          <button mat-raised-button color="accent" (click)="viewJob()">
            View Job
          </button>
        }
      </mat-card-actions>
    </mat-card>

    <mat-card class="info-card">
      <mat-card-header>
        <mat-card-title>Plugin Information</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="info-grid">
          <div class="info-item">
            <strong>Version:</strong>
            <span>{{ plugin()!.definition.plugin.version }}</span>
          </div>
          @if (plugin()!.definition.plugin.author) {
            <div class="info-item">
              <strong>Author:</strong>
              <span>{{ plugin()!.definition.plugin.author }}</span>
            </div>
          }
          <div class="info-item">
            <strong>Category:</strong>
            <span>{{ plugin()!.definition.plugin.category }}</span>
          </div>
          <div class="info-item">
            <strong>Runtime:</strong>
            <span>{{ plugin()!.definition.runtime.type }}</span>
          </div>
          <div class="info-item">
            <strong>Inputs:</strong>
            <span>{{ plugin()!.definition.inputs.length }}</span>
          </div>
          <div class="info-item">
            <strong>Outputs:</strong>
            <span>{{ plugin()!.definition.outputs?.length || 0 }}</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  }
</div>
