<div class="home-container">
  <div class="jobs-content">
    <!-- Debug Info - Always Visible -->
    <mat-card style="margin: 16px; background: #fff3cd; border-left: 4px solid #ffc107;">
      <mat-card-content style="padding: 12px;">
        <div style="font-size: 12px; font-family: monospace;">
          <strong>Debug Status:</strong><br>
          window.go: <span [style.color]="debugInfo().windowGoExists ? 'green' : 'red'">{{ debugInfo().windowGoExists ? 'EXISTS' : 'MISSING' }}</span> |
          Wails: <span [style.color]="wails.isWails ? 'green' : 'red'">{{ wails.isWails ? 'READY' : 'NOT READY' }}</span> |
          Jobs: {{ debugInfo().jobsLoaded }} |
          Loading: {{ loading() ? 'YES' : 'NO' }}
          @if (debugInfo().lastError) {
            <br><strong style="color: #c62828;">Error:</strong> {{ debugInfo().lastError }}
          }
          <br><strong>Last 3 logs:</strong>
          @for (log of debugInfo().logs.slice(-3); track $index) {
            <br>{{ log }}
          }
        </div>
      </mat-card-content>
    </mat-card>

    <div class="jobs-section">
      <div class="jobs-header">
        <h2>Jobs</h2>
        <button mat-raised-button color="primary" (click)="openImportDialog()">
          <mat-icon>upload_file</mat-icon>
          Import Data
        </button>
      </div>
      @if (loading()) {
        <div class="loading-container">
          <mat-spinner></mat-spinner>
          <p>Loading jobs...</p>
          <small style="color: #666; margin-top: 8px;">If this takes more than 5 seconds, check debug info above</small>
        </div>
      } @else if (debugInfo().lastError && !wails.isWails) {
        <div class="error-state">
          <mat-icon color="warn">error</mat-icon>
          <h3>Cannot connect to backend</h3>
          <p style="color: #666;">Wails runtime is not available</p>
          <p style="font-size: 12px; font-family: monospace; background: #f5f5f5; padding: 12px; border-radius: 4px; margin-top: 16px;">
            window.go exists: {{ debugInfo().windowGoExists ? 'Yes' : 'No' }}<br>
            window.runtime exists: {{ debugInfo().windowRuntimeExists ? 'Yes' : 'No' }}<br>
            Error: {{ debugInfo().lastError }}
          </p>
        </div>
      } @else if (jobs().length === 0) {
        <div class="empty-state">
          <mat-icon>work_outline</mat-icon>
          <p>No jobs yet</p>
          <p class="empty-state-hint">Jobs will appear here when you run analysis tasks</p>
        </div>
      } @else {
        <table mat-table [dataSource]="recentJobs()" class="jobs-table">
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let job">
              <mat-icon [color]="getStatusColor(job.status)" class="status-icon">{{ getStatusIcon(job.status) }}</mat-icon>
            </td>
          </ng-container>

          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef>Name</th>
            <td mat-cell *matCellDef="let job" (click)="viewJobDetail(job.id)" class="clickable">
              <div class="job-name-cell">
                <span class="job-name">{{ job.name }}</span>
                @if (job.error) {
                  <mat-icon color="warn" class="error-icon" [matTooltip]="job.error">error</mat-icon>
                }
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="type">
            <th mat-header-cell *matHeaderCellDef>Type</th>
            <td mat-cell *matCellDef="let job">{{ job.type }}</td>
          </ng-container>

          <ng-container matColumnDef="createdAt">
            <th mat-header-cell *matHeaderCellDef>Created</th>
            <td mat-cell *matCellDef="let job">{{ job.createdAt | date:'short' }}</td>
          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let job">
              <div class="action-buttons">
                @if (job.status === 'completed' || job.status === 'failed') {
                            <button mat-icon-button (click)="rerunJob(job.id); $event.stopPropagation()" matTooltip="Re-run job">
                              <mat-icon>replay</mat-icon>
                            </button>                }
                <button mat-icon-button (click)="deleteJob(job.id); $event.stopPropagation()" matTooltip="Delete job">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;" [class.in-progress]="row.status === 'in_progress'"></tr>
        </table>
      }
    </div>
  </div>

  <div class="system-status">
    <mat-card class="status-card">
      <mat-card-header>
        <mat-card-title>System Status</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        @if (loadingVersions()) {
          <div class="status-loading">
            <mat-spinner diameter="32"></mat-spinner>
          </div>
        } @else if (debugInfo().versionsLoaded.startsWith('✗')) {
          <div class="error-message" style="color: #c62828; font-size: 12px; padding: 8px;">
            <mat-icon color="warn" style="font-size: 16px;">error</mat-icon>
            Failed to load versions<br>
            <small>{{ debugInfo().versionsLoaded }}</small>
          </div>
        } @else {
          <div class="status-item">
            <mat-icon [color]="pythonVersion() !== 'Not detected' && pythonVersion() !== 'Not configured' && pythonVersion() !== 'Not selected' ? 'primary' : 'warn'">
              {{ pythonVersion() !== 'Not detected' && pythonVersion() !== 'Not configured' && pythonVersion() !== 'Not selected' ? 'check_circle' : 'error' }}
            </mat-icon>
            <div class="status-info">
              <div class="status-label">Python</div>
              <div class="status-value">{{ pythonVersion() }}</div>
              @if (pythonPath()) {
                <div class="status-path">{{ pythonPath() }}</div>
              }
            </div>
          </div>
          <div class="status-item">
            <mat-icon [color]="rVersion() !== 'Not detected' && rVersion() !== 'Not configured' && rVersion() !== 'Not selected' ? 'primary' : 'warn'">
              {{ rVersion() !== 'Not detected' && rVersion() !== 'Not configured' && rVersion() !== 'Not selected' ? 'check_circle' : 'error' }}
            </mat-icon>
            <div class="status-info">
              <div class="status-label">R</div>
              <div class="status-value">{{ rVersion() }}</div>
              @if (rPath()) {
                <div class="status-path">{{ rPath() }}</div>
              }
            </div>
          </div>
        }
      </mat-card-content>
    </mat-card>

    <mat-card class="status-card">
      <mat-card-header>
        <mat-card-title>Imported Files</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        @if (loadingFiles()) {
          <div class="status-loading">
            <mat-spinner diameter="32"></mat-spinner>
          </div>
        } @else if (debugInfo().filesLoaded.startsWith('✗')) {
          <div class="error-message" style="color: #c62828; font-size: 12px; padding: 8px;">
            <mat-icon color="warn" style="font-size: 16px;">error</mat-icon>
            Failed to load files<br>
            <small>{{ debugInfo().filesLoaded }}</small>
          </div>
        } @else if (importedFiles().length === 0) {
          <div class="empty-files">
            <mat-icon>folder_open</mat-icon>
            <p>No imported files</p>
          </div>
        } @else {
          <div class="files-list">
            @for (file of importedFiles(); track file.id) {
              <div class="file-item">
                <div class="file-item-info">
                  <mat-icon>insert_drive_file</mat-icon>
                  <div class="file-item-details">
                    <div class="file-item-name">{{ file.name }}</div>
                    <div class="file-item-preview">{{ file.preview }}</div>
                  </div>
                </div>
                <button mat-icon-button (click)="deleteImportedFile(file.id)" class="delete-btn">
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            }
          </div>
        }
      </mat-card-content>
    </mat-card>
  </div>
</div>
